<?php\n/*******************************************************************************\n * Reusable function to post a balanced, multi-line journal entry.\n * \n * IMPORTANT:\n * - This function assumes it is called within an existing DB transaction.\n * - It does NOT commit or rollback; the calling script is responsible for that.\n * - It requires a valid, open database connection to be passed.\n ******************************************************************************/\n\nif (function_exists(\'postToJournal\')) {\n    return;\n}\n\nfunction postToJournal(\n    mysqli $conn,\n    string $company_id,\n    int $user_id,\n    string $entry_date,\n    string $narration,\n    array $lines\n) : array {\n\n    /************************************\n     * 1. VALIDATE & BALANCE\n     ************************************/\n    $totalDebits = 0;\n    $totalCredits = 0;\n    if (count($lines) < 2) {\n        return [\"success\" => false, \"error\" => \"Journal entry requires at least two lines.\"];\n    }\n\n    foreach ($lines as $line) {\n        if (!isset($line[\'accountId\']) || !isset($line[\'debit\']) || !isset($line[\'credit\'])) {\n            return [\"success\" => false, \"error\" => \"Invalid journal line format. Each line must have accountId, debit, and credit.\"];\n        }\n        $totalDebits += (float)$line[\'debit\'];\n        $totalCredits += (float)$line[\'credit\'];\n    }\n\n    if (abs($totalDebits - $totalCredits) > 0.01) {\n        return [\"success\" => false, \"error\" => \"Journal entry is not balanced (Debits: {$totalDebits}, Credits: {$totalCredits})\"];\n    }\n    if ($totalDebits === 0.0) {\n        return [\"success\" => false, \"error\" => \"Journal entry total cannot be zero.\"];\n    }\n\n    try {\n        /************************************\n         * 2. DETERMINE STATUS (fixed to \'posted\')\n         ************************************/\n        $status = \'posted\';\n\n        /************************************\n         * 3. GENERATE VOUCHER NUMBER\n         ************************************/\n        $year = date(\'Y\', strtotime($entry_date));\n        $seqSql = \"SELECT MAX(CAST(SUBSTRING(voucher_number, 6) AS UNSIGNED)) AS max_no FROM journal_vouchers WHERE voucher_number LIKE ?\";\n        $like = $year . \'-\%\';\n        $seqStmt = $conn->prepare($seqSql);\n        if (!$seqStmt) throw new Exception(\"Prepare failed (voucher_number): \" . $conn->error);\n        $seqStmt->bind_param(\"s\", $like);\n        $seqStmt->execute();\n        $res = $seqStmt->get_result()->fetch_assoc();\n        $seqStmt->close();\n        $nextNo = ($res[\'max_no\'] ?? 0) + 1;\n        $voucherNumber = $year . \'-\' . str_pad($nextNo, 5, \'0\', STR_PAD_LEFT);\n\n        /************************************\n         * 4. INSERT VOUCHER HEADER\n         ************************************/\n        $voucherSql = \"INSERT INTO journal_vouchers (company_id, created_by_id, voucher_number, entry_date, narration, total_debits, total_credits, status) VALUES (?, ?, ?, ?, ?, ?, ?, ?)\";\n        $voucherStmt = $conn->prepare($voucherSql);\n        if (!$voucherStmt) throw new Exception(\"Prepare failed (voucher_header): \" . $conn->error);\n        $voucherStmt->bind_param(\"sissddds\", $company_id, $user_id, $voucherNumber, $entry_date, $narration, $totalDebits, $totalCredits, $status);\n        $voucherStmt->execute();\n        $voucherId = $voucherStmt->insert_id;\n        $voucherStmt->close();\n        if($voucherId == 0) {\n            throw new Exception(\"Failed to insert journal voucher header.\");\n        }\n\n        /************************************\n         * 5. INSERT JOURNAL LINES\n         ************************************/\n        $lineSql = \"INSERT INTO journal_voucher_lines (company_id, voucher_id, account_id, description, debit, credit) VALUES (?, ?, ?, ?, ?, ?)\";\n        $lineStmt = $conn->prepare($lineSql);\n        if (!$lineStmt) throw new Exception(\"Prepare failed (voucher_lines): \" . $conn->error);\n\n        foreach ($lines as $line) {\n            $desc = $line[\'description\'] ?? $narration;\n            $lineStmt->bind_param(\"sisdsd\", $company_id, $voucherId, $line[\'accountId\'], $desc, $line[\'debit\'], $line[\'credit\']);\n            $lineStmt->execute();\n        }\n        $lineStmt->close();\n\n        /************************************\n         * 6. RETURN SUCCESS\n         ************************************/\n        return [\n            \"success\" => true,\n            \"voucher_id\" => $voucherId,\n            \"voucher_number\" => $voucherNumber,\n        ];\n\n    } catch (Throwable $e) {\n        // The calling function is responsible for rollback.\n        return [\n            \"success\" => false,\n            \"error\" => $e->getMessage(),\n            \"details\" => \"Line: \" . $e->getLine() . \", File: \" . $e->getFile()\n        ];\n    }\n}\n?>